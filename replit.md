# Sheet Application (Airtable Clone)

## Overview
This project is a modern spreadsheet/database application, aiming to replicate and enhance functionalities similar to Airtable. Built with React, Vite, and TypeScript, it focuses on high performance, scalability, and an improved user experience, particularly through a canvas-based grid view and a Kanban board. The application offers comprehensive CRUD operations for data management and integrates AI capabilities for natural language data interaction. It seeks to modernize a legacy codebase using current best practices.

## Running the Application

### Three Services
1. **Frontend** (port 5000): `scripts/vite-proxy.cjs` — Stable proxy on 5000 forwarding to Vite dev server on 5001. Uses `setsid` detachment so the proxy survives Replit checkpoint SIGKILL cycles; Vite auto-restarts on exit.
2. **Backend API** (port 3000): NestJS backend with Redis — `redis-server --daemonize yes ... && node dist/main.js`
3. **AI Service** (port 3001): Express/TypeScript AI service — `npx tsx src/server.ts`

### Frontend Stability Architecture
The "Start application" workflow command uses `setsid` to start `scripts/vite-proxy.cjs` in a detached session, so it's not part of the workflow's process group. This means Replit's checkpoint system (which sends SIGKILL to process groups) doesn't kill the proxy between agent actions. Vite runs on port 5001 internally and the proxy keeps port 5000 permanently bound.

### Required Environment Variables
- `ENV=development` — Bypasses external permission API, grants full owner access
- `JWT_SECRET=hockeystick` — Matches hardcoded symmetric key in token.utils.ts
- `REDIS_HOST=127.0.0.1` — Redis connection host
- `REDIS_PORT=6379` — Redis connection port
- `VITE_DEFAULT_SHEET_PARAMS` — Base64-encoded JSON with keys `a` (baseId), `t` (tableId), `v` (viewId)
- `VITE_AUTH_TOKEN` — JWT token for API authentication (set in .env)
- `OPENAI_API_KEY` — (Optional) Required only for AI features; service starts without it

### Backend Build & Deploy
- Backend uses **pnpm** with private registry at `https://npm.gofo.app/` (auth token in `sheets-backend/.npmrc`)
- After any backend source changes: `cd sheets-backend && pnpm run build` then restart Backend API workflow
- Prisma migrations: `cd sheets-backend && npx prisma migrate deploy`

### Seeding Data
- Run `node scripts/seed-test-data.cjs` to populate demo data (requires Backend API running)
- Creates "TINYTable Demo" sheet with Projects (8 records) and Tasks (10 records) tables
- Generates `seed-result.json` with IDs; update `VITE_DEFAULT_SHEET_PARAMS` accordingly
- Phone number fields use JSONB format: `{ countryCode, countryNumber, phoneNumber }`
- NUMBER fields require options: `{ allowNegative: boolean, allowFraction: boolean }`

### Current Seed IDs
- baseId: `mHB2FJesH1sa9krMHPR9S_1Q` (TINYTable Demo)
- Projects table: `cmm4efmp50005k4xwysuegjh4`, view: `cmm4efmr20006k4xwp9rsi3xs`
- Tasks table: `cmm4efmzm000mk4xws005c1yo`, view: `cmm4efn08000nk4xw2aqiwzke`
- Note: VITE_DEFAULT_SHEET_PARAMS (development env) and .env.local must both be updated after re-seeding

### All Field Types Seed
- Run `node scripts/seed-all-field-types.cjs` to create the "Field Type Showcase" table with 27 field types and 8 records
- Covers every backend QUESTION_TYPE: SHORT_TEXT, LONG_TEXT, NUMBER, EMAIL, PHONE_NUMBER, CURRENCY, CHECKBOX, SCQ, MCQ, DATE, TIME, RATING, SLIDER, OPINION_SCALE, YES_NO, ZIP_CODE, ADDRESS, DROP_DOWN, LIST, RANKING, SIGNATURE, CREATED_TIME, CREATED_BY, LAST_MODIFIED_TIME, LAST_MODIFIED_BY, AUTO_NUMBER, BUTTON
- JSONB field formats: MCQ=`["val1","val2"]`, PHONE_NUMBER=`{countryCode,countryNumber,phoneNumber}`, CURRENCY=`{countryCode,currencyCode,currencySymbol,currencyValue}`, TIME=`{time,meridiem,ISOValue}`, ZIP_CODE=`{countryCode,zipCode}`, ADDRESS=`{fullName,addressLineOne,...}`, LIST=`["item"]`, RANKING=`[{id,rank,label}]`, DROP_DOWN=`[{id,label}]`
- Currency renderer (`paintCurrency` in `cell-painters.ts`) and formatter (`formatCell` in `formatters.ts`) normalize both legacy keys (`symbol`/`value`) and canonical keys (`currencySymbol`/`currencyValue`) for backward compatibility
- Dropdown renderer (`paintDropDown` in `cell-painters.ts`) extracts labels from `{id, label}` objects via `getDropDownLabel()` helper; supports both string and object option formats
- Dropdown editor (`DropDownEditor` in `cell-editor-overlay.tsx` and `expanded-record-modal.tsx`) handles multi-select with `{id, label}` objects — shows colored chips (8 pastel colors cycling: blue, purple, green, orange, pink, teal, yellow, lime with dark mode variants), search input with magnifying glass icon, checkbox option list, expanded view toggle; commits as `[{id, label}]` array format; `hasUserEdited` flag prevents no-op saves; SCQ/MCQ/DropDown added to `isPopupEditor` list for proper popup positioning
- Currency editor (`CurrencyInput` in `cell-editor-overlay.tsx`) has left-side country selector (flag + currency code + symbol + chevron opens searchable country popover) and right-side numeric input; commits `{countryCode, currencyCode, currencySymbol, currencyValue}`; country popover positioned absolutely below with search, scrollable country list with flags; Escape closes popover first, then cancels editor
- Expanded record modal Currency uses standalone `CurrencyEditor` component (`src/components/editors/currency-editor.tsx`) with `CountryPicker` (`src/components/editors/country-picker.tsx`) — both theme-aware (bg-background, bg-popover, text-foreground, border-border)
- Phone number editor (`PhoneNumberInput` in `cell-editor-overlay.tsx`) matches Currency editor style: left-side country selector (~30% max-width with flag + "+countryNumber" + chevron opens searchable country popover with all countries), right-side tel input (~70% flex-1); commits `{countryCode, countryNumber, phoneNumber}` or null; standalone `PhoneNumberEditor` component (`src/components/editors/phone-number-editor.tsx`) for expanded record modal uses `CountryPicker` with `showPhoneCode` prop
- Countries data module (`src/lib/countries.ts`) provides COUNTRIES record, getCountry(), getAllCountryCodes(), getFlagUrl() using flagcdn.com — used by both Currency editor and phone number rendering
- Currency & Phone number editors both use ~30:70 ratio (country selector : value input) via `maxWidth: '30%'` on left side and `flex-1` on right side; `CountryPicker` component supports `compact` prop for smaller sizing in grid editors
- Date format configuration: Field modal shows Date Format dropdown (DD/MM/YYYY, MM/DD/YYYY, YYYY/MM/DD) and Include Time toggle for DateTime, CreatedTime, and LastModifiedTime field types; options saved as `{dateFormat: 'DDMMYYYY'|'MMDDYYYY'|'YYYYMMDD', includeTime: boolean}` in field options; pre-filled when editing existing fields
- Date display formatting: `formatDateDisplay()` utility in `formatters.ts` formats raw ISO date strings into user-configured formats; applied during cell creation in `formatCell` for DateTime/CreatedTime/LastModifiedTime; `updated_field` socket handler in `useSheetData.ts` re-formats all date cells when field options change
- Field modal edit pre-fill: `handleEditField` in `App.tsx` uses `rawOptions` (full backend options object) instead of `column.options` (which may be a flat array for select types). The field modal useEffect reads choices from `data.options.options` (DropDown format), `data.options.choices` (SCQ/MCQ backend format with `{name, color}` objects), or a flat array. This ensures all field types pre-fill correctly when editing.
- Backend option formats: SCQ/MCQ use `{ choices: [{name, color}] }`, DropDown uses `{ options: [{id, label}] }`, Rating uses `{ maxRating }`, Slider uses `{ minValue, maxValue }` (defaults: 0, 10), OpinionScale uses `{ maxValue }` (default: 10), Currency uses `{ currencySymbol }`, Button uses `{ label, style, actionType, url, confirm, maxCount }`, Date types use `{ dateFormat, includeTime }`. The formatter maps `choices[].name` to column options strings.
- Slider, OpinionScale, and Rating editors use **inline overlay** positioning (same as text/number editors — overlaid on the cell with border alignment) NOT popup positioning. They are in the `isInlineOverlayEditor` category in `cell-editor-overlay.tsx`. Slider shows a range input + `value/maxValue` label; OpinionScale shows numbered buttons 1..maxValue; Rating shows interactive Lucide `Star` icons with hover preview (30% opacity amber), click toggle (clicking same rating clears to null), keyboard input (0-9 number keys, double-tap 1+0 for 10 within 500ms), and Enter/Tab/Escape/blur for save/cancel/navigate. All three handle Enter/Tab/Escape/blur for save/cancel. Canvas painters and cell renderers handle null data gracefully (show empty cell, not 0/maxValue).
- Ranking field: Full create/edit/render/editor flow. Field modal shows "Options" config with drag-handle-enabled `ChoiceOptionsEditor` (each row: text input + GripVertical drag handle + X remove button, "Add Choice" button at bottom). Options saved as `[{ id: crypto.randomUUID(), label }]` (preserves existing IDs on edit). `RankingInput` editor in cell-editor-overlay uses `IRankingItem[]` data format (`{ id, rank, label }`), drag-and-drop reordering with visual feedback, rank badges, blur/Enter/Tab save, Escape cancel. Canvas painter `paintRanking` renders indigo chips with `rank. label`. Cell renderer shows inline chips. Ranking is a popup editor (in `isPopupEditor` list). Backend stores ranking options as `{ options: [{ id, label }] }` and cell data as JSONB `[{ id, rank, label }]`.
- Comment sidebar: Only opens when clicking the comment column area (between `rowHeaderWidth` and `effectiveRowHeaderWidth`) or the expand icon — NOT on regular cell clicks. State controlled by `commentSidebarRecordId`/`commentSidebarOpen` in `useGridViewStore`.
- Not seeded: FORMULA, LINK, LOOKUP, ROLLUP, ENRICHMENT (require existing fields/tables as dependencies)

## User Preferences
- Legacy folder must remain completely untouched
- Do NOT copy code from legacy - recreate fresh with best practices
- Canvas-based grid rendering (not HTML/CSS) for performance at scale
- Tailwind v4 with CSS-based configuration
- Island design pattern: UI elements float as self-contained, elevated islands (rounded corners, subtle shadows/depth, backdrop blur)
- Brand: TINYTable (green gradient #369B7D → #4FDB95), SVG logo at brand/tiny-sheet.svg, copied to src/assets/
- Brand color tokens: brand-50 through brand-900 defined in src/index.css @theme, primary color is #39A380
- Island CSS utilities: .island, .island-elevated, .island-subtle, .island-focus, .brand-gradient (all with dark mode variants)
- Theme system: Accent color presets (10 colors), dark/light mode toggle, URL param embedding (?theme=dark&accent=hex)
- Theme-aware header/footer with accent gradient tints, branded active view pills, sidebar highlights

## System Architecture

### Tech Stack
- **Frontend**: React 18, TypeScript, Vite
- **Styling**: Tailwind CSS v4, shadcn/ui, Radix UI
- **State Management**: Zustand
- **Backend**: NestJS
- **AI Service**: Express/TypeScript
- **Database**: PostgreSQL
- **Cache**: Redis
- **Real-time**: Socket.IO

### Core Features
- **High-Performance Grid**: Canvas-based rendering supporting 22 cell types, multi-cell selection, keyboard navigation, and rich cell editors.
- **Multiple Views**: Kanban, Calendar, Gantt, Gallery, and Form views with full CRUD for views and tables.
- **AI Chat Panel**: A sliding panel for natural language interaction with data, streaming GPT-4.1 responses, conversation persistence, and action generation (filter, sort, group, conditional formatting, cross-base queries, record CRUD, formula generation).
- **Advanced Field Types**: Link, CreatedBy, LastModifiedBy, LastModifiedTime, ID, Checkbox, Lookup, and Rollup with a dependency and recalculation engine. AutoNumber, User, and Button types exist in the system but are hidden from the field creation modal.
- **Field Creation Modal**: Categories: AI & Enrichment, Basic (Short Text, Long Text, Number, Yes/No), Select, Date & Time, Contact & Location, Media, Links & Lookups, People & System (CreatedBy, LastModifiedBy, LastModifiedTime, ID), Advanced. No description text on field type entries. `CellType.LongText` maps to backend `LONG_TEXT`.
- **System Fields & Non-Editable UX**: System fields (CreatedTime, CreatedBy, LastModifiedBy, LastModifiedTime, AutoNumber, ID) are consistently non-editable across all surfaces. `isSystemField(cellType)` utility in `src/types/cell.ts` identifies system fields. Visual treatment: diagonal stripe background (cached `CanvasPattern` for performance) + vector-drawn lock badge in top-right corner of cells + lock badges in column headers. CSS class `.system-field-cell` provides matching stripes in DOM (light + dark mode). Expanded record modal shows matching stripe bg + "SYSTEM" pill badge with lock icon. Cell editor overlay returns `null` (no editor) for all system fields. ID field maps to backend `AUTO_NUMBER` type.
- **Rating Field**: Canvas painter clips stars to cell bounds and auto-scales star size when column is narrow (responsive). Editor overlay expands to fit all stars (20px stars with 4px gap) with shadow/rounded border, not constrained to cell width. DOM renderer uses `overflow-hidden` + `shrink-0` stars. Expanded record modal uses larger clickable stars with yellow fill. Click-to-commit pattern: clicking a star commits immediately and closes editor. Clicking the current rating value resets to 0. Keyboard: 0-9 for quick entry, double-tap "1" then "0" within 500ms for 10.
- **Server-Side Operations**: Filter, sort, and group operations are processed server-side for scalability with large datasets.
- **Record History/Audit Trail**: Per-table history tracking with `before_value` and `after_value` for changes.
- **Internationalization (i18n)**: 4 languages (English, Spanish, Arabic, Portuguese) via `react-i18next` with 3 namespaces (common, grid, views). Toolbar, field modal, sort/group/filter modals, and cell editors all use `t()` translation calls.
- **Workflow CTA**: Island-styled sidebar card linking to future workflow automation builder.
- **Cell Editor System**: Google Sheets/Airtable-style cell editing with precise sizing and keyboard shortcuts. Inline editors (String, Number, Currency, ZipCode) use legacy border pattern: `width: rect.width+4`, `height: rect.height+4`, `marginLeft: -2`, `marginTop: -2`, `border: 2px solid #39A380`, `box-sizing: border-box` — aligns editor border perfectly over cell border. Popup editors (Select, MultiSelect, Rating, DateTime, Time, etc.) open below the cell with min-width. **DateTime editor** (`src/components/editors/datetime-editor.tsx`): Island-design floating card with separate date and optional time inputs. Fixes UTC time-shift bug by converting stored ISO string to LOCAL date/time using `d.getFullYear()/.getMonth()/.getDate()/.getHours()/.getMinutes()` (not `.toISOString()` which is always UTC). Commits proper ISO UTC string via `new Date(localCombined).toISOString()`. When `options.includeTime=false`, preserves the stored time portion. Clear + Apply buttons. **Time editor** (`src/components/editors/time-editor.tsx`): Island-design floating card that correctly reads `ITimeData = {time, meridiem, ISOValue, timeZone?}` from `cell.data`. Extracts initial 24hr time from `ISOValue` using `new Date(iso).getHours()/.getMinutes()`. For 12hr mode, shows AM/PM toggle buttons that actually adjust the 24hr time (clicking PM on 3:00 → 15:00, clicking AM → 3:00). Commits full `ITimeData` object with `time`, `meridiem`, `ISOValue` (today's date + selected time), and `timeZone` from `Intl.DateTimeFormat().resolvedOptions().timeZone`. `formatCellDataForBackend` serializes Time as `JSON.stringify(ITimeData)` and DateTime as the ISO string directly. Optimistic `displayData` in `applyCellChange` (App.tsx) uses `formatDateDisplay` for DateTime and `time + meridiem` for Time. **Fixed-position editor**: Editor position is captured once when editing starts via `useEffect([editingCell])` using `getCellRect()` viewport-relative coordinates, then stored in state. The editor stays at its fixed screen position while the canvas scrolls underneath (matching legacy `fixedEditorPosition` pattern). Editor is wrapped in a full-viewport overlay div (`position: absolute, inset: 0, pointerEvents: none, zIndex: 10`) with `data-editor-container` attribute for wheel event interception — scrolling inside the editor (e.g., dropdowns) doesn't scroll the grid. Editor is clamped to never overlap row headers (`rowHeaderWidth`) or column headers (`headerHeight`). Keyboard: Enter → open editor / commit+move down, Shift+Enter → commit+move up, Tab → commit+move right, Shift+Tab → commit+move left, Escape → cancel, F2 → open editor, Delete/Backspace → clear cell, printable char → open editor with that character pre-filled. `initialCharacter` state in grid-view controls type-to-start behavior. `onCommitAndNavigate` callback handles directional navigation after commit. Files: `cell-editor-overlay.tsx` (sizing/positioning/editor switch), `grid-view.tsx` (keyboard routing, overlay wrapper, navigation).
- **UI/UX Enhancements**: Teable-style layout, overhauled toolbar, redesigned popovers, enhanced search, resizable sidebar, and improved cell editor positioning.
- **Column Color Persistence**: Column colors are saved via `updateColumnMeta` using the backend's array format `[{id: numericFieldId, color: "#hex"}]`. The color-loading `useEffect` reads `columnMeta` from the view, matches by `String(c.rawId) === fieldId`, and populates `useUIStore.columnColors`. Dependencies: `_currentView?.id`, `_currentView?.columnMeta`, `currentTableId`, `activeData?.columns?.length`. Hide-field persistence also uses the array format with `is_hidden` and `width`.
- **Comment Indicators**: Dedicated auto-hiding comment column between row header and first data column. When any row has comments, a 28px-wide column appears showing speech bubble icons on commented rows. When no rows have comments, the column hides completely (zero width). Implemented via `effectiveRowHeaderWidth` getter in `renderer.ts` and dynamic `rowHeaderWidth` in `CoordinateManager`. Comment counts fetched via `/comment/counts-by-table` endpoint.
- **Toggleable Comment Sidebar**: 320px comment panel on the right side of the grid, hidden by default. Opens when clicking a row or comment icon (sets `commentSidebarRecordId` + `commentSidebarOpen: true`). Has a header with "Comments" title and X close button. Close button sets `commentSidebarOpen: false`. State: `commentSidebarRecordId` (which record) and `commentSidebarOpen` (visibility) in `useGridViewStore`. Comment column clicks (between `rowHeaderWidth` and `effectiveRowHeaderWidth`) intercepted in `grid-view.tsx` `handleClick`. `CommentPanel` rendered in `App.tsx` conditionally on `commentSidebarOpen`.
- **Enrichment Fields**: AI-powered data enhancement with Company/Person/Email enrichment types. Parent enrichment field creates child output columns with **island-style headers** — a unified rounded-rect container (10px radius, purple gradient fill, soft shadow, inner glow) that visually separates enrichment columns from the flat grid. `paintEnrichmentIslands()` in `renderer.ts` draws the island background before individual column headers; `paintColumnHeader()` skips flat backgrounds for enrichment members and draws subtle dashed dividers between group members inside the island. Collapse/expand grouping with chevron, play button trigger in empty cells, loading state during processing, and "Enrich All Records" in column header context menu. Config at `src/config/enrichment-mapping.ts`. APIs: createEnrichmentField, processEnrichment, processEnrichmentForAll. Enrichment creation/editing uses a **connected side panel** (not inline) — when "Enrichment" type is selected in the add-field popover, a side panel appears attached to the right (or left if near screen edge) with entity type cards, identifier mapping, output field selection, and auto-update toggle. Side panel component: `EnrichmentSidePanel` in `field-modal.tsx` — works in both create AND edit modes (loads existing enrichment config from field options). Side panel has AI-forward design: gradient header (purple→blue), gradient text, floating sparkle animation, glow effects on selected cards, backdrop-blur on inputs, and pulse animations. Column store synced via `useEffect` in `grid-view.tsx` to populate identifier mapping dropdowns. CSS animations (`animate-float`, `animate-pulse-smooth`) defined in `src/index.css`.
- **Get Started Modal**: `src/components/get-started-modal.tsx` — Two-panel island-design modal triggered by the "Get Started" pill button in the header (temporary trigger, to be wired to URL/session logic later). Left panel: green-gradient card with inline SVG spreadsheet illustration + "Create blank table" CTA (full card is a button). Center: "OR" circular badge on a vertical divider line. Right panel: purple "AI-Powered Discovery" pill badge + scrollable list of 6 AI option cards (Find Customer Company/People, Find Competitors, Enrich Email/Company/Person). Each option card calls `onSelectOption(id)` — logic left as console.log stubs for future wiring. Uses `Dialog/DialogContent` from `@/components/ui/dialog`, theme-aware bg tokens, dark mode compatible. Button in header uses `Sparkles` icon + "Get Started" label, styled as a rounded-full outline pill.
- **Create View Modal**: `src/components/create-view-modal.tsx` — Dialog opened by the "+ Add view" button in the header. Contains a name input (required), view type card selector (Grid, Gallery, Kanban, Calendar, Form), and a Kanban-specific stacking field dropdown (lists SCQ/SingleSelect columns from `useFieldsStore.allColumns`). On submit, calls `createView` API then `addView`/`setCurrentView` in the view store. State (`createViewModalOpen`) lives in header.tsx. Replaces the old instant-create popover pattern.
- **CSV Import Modal**: Two-path import dialog (`src/views/grid/import-modal.tsx`) triggered from the toolbar's "..." menu. **Path A — Import to This Table**: 4-step wizard (Upload → Column Mapping → Validation → Import). Upload supports drag-and-drop CSV/XLSX/XLS, "first row is header" toggle, download template. Column mapping uses fuzzy matching with confidence badges (Exact/Fuzzy %), allows mapping to existing fields or creating new ones. Validation shows valid/warning/error row counts, skip-error-rows toggle, and append/replace mode selector. Import calls `uploadCSVForImport` then `importToExistingTable` API endpoint. **Path B — Import to New Table**: 3-step wizard (Upload → Configure Fields → Import). Configure step allows editing field names inline (pencil icon), selecting field types from a custom icon-dropdown (`FieldTypeSelect` component), toggling include/exclude per field, and setting the table name. Calls `importToNewTable` API endpoint. Field types supported: String, Number, DateTime, Currency, Rating, YesNo, SCQ, MCQ, DropDown, Email, PhoneNumber, Checkbox. Auto-detection infers types from first 50 rows of data. **Type mapping**: Frontend `CellType` values (String, Number, DateTime, etc.) are converted to backend `QUESTION_TYPE` values (SHORT_TEXT, NUMBER, DATE, etc.) via `FRONTEND_TO_BACKEND_TYPE` map and `toBackendType()` helper. **Payload construction**: For existing fields, `field_id` uses `rawId` (numeric) from `ExtendedColumn`, `dbFieldName` is included for DB column identification, and `prev_index` tracks the source CSV column index. For new fields, `dbFieldName` is omitted so the backend creates the field. Store: `importModalMode` in `useModalControlStore` tracks "existing"|"new" mode. Backend endpoints: `POST /table/add_csv_data_to_existing_table` and `POST /table/add_csv_data_to_new_table`.
- **Share Modal**: Google Sheets-inspired sharing dialog (`src/views/sharing/share-modal.tsx`) with collapsible section layout: (1) **Add People** (always open) — search input with embedded role selector ("Viewer ▾") flush inside the input's right edge (Google Sheets style), multi-select pill/chip tags for selected users, invite button appears contextually only when users are selected, Enter key triggers invite; (2) **People with Access** — collapsed by default, shows stacked avatar previews (up to 4 with +N overflow) and count text when collapsed; when expanded shows member list with hover-reveal role dropdowns (plain text becomes clickable on hover), owner shown with crown icon, dirty-state tracking (amber highlight on modified rows), inline per-section Save/Cancel bar at bottom of expanded area; section stays expanded and prevents collapsing when unsaved changes exist; (3) **General Access** — collapsed by default, shows colored status badge when collapsed (green "Anyone with link" pill or muted "Restricted" pill); when expanded shows full card with large circle icon, description text, and upward-opening dropdown; inline per-section Save/Cancel bar; section stays expanded when dirty; (4) **Footer** — "Copy link" rounded pill (left, emerald feedback on click) + "Done" button (right), no global save/cancel. Hooks: `useShareModal` (per-section save/cancel via `handleSaveMembers`/`handleSaveGeneralAccess`/`handleCancelMembers`/`handleCancelGeneralAccess`, separate dirty flags `hasMemberChanges`/`hasGeneralAccessChanges`, member saves use original general_role to avoid leaking uncommitted changes), `useSearchInvite` (300ms debounced search via `/user-sdk/search`, shared `inviteRole` for all selected users). API functions: `getShareMembers`, `inviteShareMembers`, `shareAsset`, `findOneAsset`, `searchUsers`.
- **Export Sidebar**: Export functionality uses a right slide-in sidebar panel (not a centered modal) with CSV, Excel, JSON, and PDF formats.
- **Hide Fields Popover**: Hide fields uses a toolbar dropdown popover (matching Filter/Sort/Group pattern), not a modal.
- **Row Header UX**: Row numbers always visible on hover alongside checkbox and expand controls; single-click expand icon opens record detail.
- **Template-Driven Table Creation**: "New Table" button opens a modal (`src/components/create-table-modal.tsx`) with 6 predefined templates (CRM Contacts, Sales Pipeline, Content Calendar, Project Tracker, Bug Tracker, Inventory) plus a blank table option with custom name input. Templates defined in `src/config/table-templates.ts`. Uses `create_table` + `create_multiple_fields` API endpoints to create table with proper schema. Each template specifies field names and types (SHORT_TEXT, NUMBER, DATE).

### Data Management
- **Prisma Schema**: Defines models like Space, Base, TableMeta, Field, View, Comment, AiConversation, etc., with camelCase Prisma fields mapped to snake_case DB columns.
- **Seed Data**: `scripts/seed-test-data.cjs` creates demo data via API endpoints. Phone numbers must be JSONB objects `{ countryCode, countryNumber, phoneNumber }`. NUMBER fields require `{ allowNegative, allowFraction }` options.
- **Cached Plan Recovery**: When PostgreSQL raises "cached plan must not change result type" (after ALTER TABLE from field creation), `record.service.ts` throws a `CachedPlanError`. The HTTP controller (`withCachedPlanRetry`) and WebSocket gateway catch it, call `$disconnect()/$connect()` on PrismaClient to reset the connection pool (NOT `DEALLOCATE ALL` which breaks Prisma's internal prepared statements), then retry the query.
- **WebSocket Data Flow**: Real-time updates for records via Socket.IO, with client-side room management.
- **Frontend Sheet Resolution**: `useSheetData.ts` fallback logic iterates sheets in reverse order, looking for one with active tables (skips empty auto-created sheets).

## External Dependencies
- **Icons**: lucide-react
- **UI Components**: shadcn/ui (leveraging Radix UI primitives)
- **Kanban DnD**: @hello-pangea/dnd
- **AI Integration**: OpenAI GPT-4.1 via Replit AI Integrations
