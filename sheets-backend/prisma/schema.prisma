generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model field {
    id               Int       @id @default(autoincrement())
    name             String
    description      String?
    options          Json?     @map("options")
    type             String
    cellValueType    String    @map("cell_value_type")
    dbFieldType      String    @map("db_field_type")
    dbFieldName      String    @map("db_field_name")
    createdTime      DateTime  @default(now()) @map("created_time")
    lastModifiedTime DateTime? @updatedAt @map("last_modified_time")
    deletedTime      DateTime? @map("deleted_time")
    TableMeta         TableMeta? @relation(fields: [tableMetaId], references: [id])
    tableMetaId       String?
    nodeId            Json?      @map("node_id")
    status            String     @default("active")
    source_id         Int?
    computedFieldMeta Json?      @map("computed_field_meta")
    fieldFormat       Json?      @map("field_format")
    lookupOptions     Json?      @map("lookup_options")
    expression        String?
}

model Ops {
    id          Int      @id @default(autoincrement())
    docId       String   @map("doc_id")
    docType     String   @map("doc_type")
    version     Int
    operation   String
    createdTime DateTime @default(now()) @map("created_time")
    createdBy   String   @map("created_by")

    @@map("ops")
}

model Space {
    id               String    @id @default(cuid()) @map("id")
    name             String
    credit           Int?
    deletedTime      DateTime? @map("deleted_time")
    createdTime      DateTime  @default(now()) @map("created_time")
    createdBy        String    @map("created_by")
    lastModifiedBy   String?   @map("last_modified_by")
    lastModifiedTime DateTime? @updatedAt @map("last_modified_time")
    status           String    @default("active")

    baseGroup Base[]

    @@map("space")
}

model Base {
    id               String    @id @default(cuid()) @map("id")
    spaceId          String    @map("space_id")
    name             String
    order            Float
    icon             String?
    schemaPass       String?   @map("schema_pass")
    deletedTime      DateTime? @map("deleted_time")
    createdTime      DateTime  @default(now()) @map("created_time")
    createdBy        String    @map("created_by")
    lastModifiedBy   String?   @map("last_modified_by")
    lastModifiedTime DateTime? @updatedAt @map("last_modified_time")
    status           String    @default("active")
    source           String?   @default("")

    space  Space       @relation(fields: [spaceId], references: [id])
    tables TableMeta[]

    @@index([order])
    @@map("base")
}

model TableMeta {
    id               String       @id @default(cuid())
    baseId           String       @map("base_id")
    name             String
    description      String?
    icon             String?
    dbTableName      String?      @map("db_table_name")
    version          Int
    order            Float
    createdTime      DateTime     @default(now()) @map("created_time")
    lastModifiedTime DateTime?    @updatedAt @map("last_modified_time")
    deletedTime      DateTime?    @map("deleted_time")
    createdBy        String       @map("created_by")
    lastModifiedBy   String?      @map("last_modified_by")
    base             Base         @relation(fields: [baseId], references: [id])
    fields           field[]
    views            View[]
    dataStreams      DataStream[]
    status           String       @default("active")
    source_id        String?
    computedConfig   Json?        @default("{}") @map("computed_config")

    @@index([order])
    @@map("table_meta")
}

model View {
    id               String    @id @default(cuid())
    user_id          String?   @map("user_id")
    name             String
    description      String?
    tableId          String    @map("table_id")
    type             String
    sort             Json?
    filter           Json?
    group            Json?
    options          Json?
    order            Float
    version          Int
    columnMeta       String    @map("column_meta")
    enableShare      Boolean?  @map("enable_share")
    shareId          String?   @map("share_id")
    shareMeta        String?   @map("share_meta")
    createdTime      DateTime  @default(now()) @map("created_time")
    lastModifiedTime DateTime? @updatedAt @map("last_modified_time")
    deletedTime      DateTime? @map("deleted_time")
    createdBy        String    @map("created_by")
    lastModifiedBy   String?   @map("last_modified_by")
    table            TableMeta @relation(fields: [tableId], references: [id])
    source_id        String?
    status           String    @default("active")
    orderColumn      String?   @map("order_column")
    isLocked         Boolean?  @default(false) @map("is_locked")

    @@index([order])
    @@map("view")
}

model DataStream {
    id                String             @id @default(cuid())
    tableId           String             @map("table_id")
    webhookUrl        String             @map("webhook_url")
    isStreaming       Boolean            @default(false) @map("is_streaming")
    createdTime       DateTime           @default(now()) @map("created_time")
    lastModifiedTime  DateTime?          @updatedAt @map("last_modified_time")
    table             TableMeta          @relation(fields: [tableId], references: [id])
    eventType         Json?              @map("event_type")
    linkedAssetId     String?            @map("linked_asset_id")
    triggerType       String?            @map("trigger_type")
    triggerSchedules  TriggerSchedule[]
    scheduledTriggers ScheduledTrigger[]
    status            String?            @default("active")

    @@unique([tableId, webhookUrl])
    @@map("data_stream")
}

model TriggerSchedule {
    id                String             @id @default(cuid())
    dataStreamId      String             @map("data_stream_id")
    fieldId           Int                @map("field_id")
    type              String
    offsetMinutes     Int                @map("offset_minutes")
    name              String             @map("name")
    status            String             @default("active")
    createdTime       DateTime           @default(now()) @map("created_time")
    lastModifiedTime  DateTime?          @updatedAt @map("last_modified_time")
    deletedTime       DateTime?          @map("deleted_time")
    dataStream        DataStream         @relation(fields: [dataStreamId], references: [id], onDelete: Cascade)
    scheduledTriggers ScheduledTrigger[]

    @@index([dataStreamId])
    @@map("trigger_schedule")
}

model ScheduledTrigger {
    id                String          @id @default(cuid())
    dataStreamId      String          @map("data_stream_id")
    triggerScheduleId String          @map("trigger_schedule_id")
    recordId          Int             @map("record_id")
    tableId           String          @map("table_id")
    originalFieldId   Int             @map("original_field_id")
    scheduledTime     DateTime        @map("scheduled_time") @db.Timestamptz(3)
    originalTime      DateTime        @map("original_time") @db.Timestamptz(3)
    state             String          @default("PENDING")
    status            String          @default("active")
    retryCount        Int             @default(0) @map("retry_count")
    maxRetries        Int             @default(3) @map("max_retries")
    nextRetryTime     DateTime?       @map("next_retry_time") @db.Timestamptz(3)
    lastError         String?         @map("last_error")
    createdTime       DateTime        @default(now()) @map("created_time")
    lastModifiedTime  DateTime?       @updatedAt @map("last_modified_time")
    deletedTime       DateTime?       @map("deleted_time")
    dataStream        DataStream      @relation(fields: [dataStreamId], references: [id], onDelete: Cascade)
    triggerSchedule   TriggerSchedule @relation(fields: [triggerScheduleId], references: [id], onDelete: Cascade)

    @@index([status, state, scheduledTime])
    @@index([status, state, nextRetryTime])
    @@index([triggerScheduleId])
    @@map("scheduled_trigger")
}

model Reference {
    id          Int      @id @default(autoincrement())
    fromFieldId Int
    toFieldId   Int
    createdTime DateTime @default(now())

    @@unique([fromFieldId, toFieldId])
    @@index([fromFieldId])
    @@index([toFieldId])
    @@map("reference")
}

model Comment {
    id          String    @id @default(cuid())
    tableId     String    @map("table_id")
    recordId    String    @map("record_id")
    parentId    String?   @map("parent_id")
    content     String
    userId      String    @map("user_id") @db.VarChar(255)
    userName    String?   @map("user_name") @db.VarChar(255)
    userAvatar  String?   @map("user_avatar")
    reactions   Json?     @default("{}")
    createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
    updatedAt   DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)
    deletedAt   DateTime? @map("deleted_at") @db.Timestamptz(6)
    parent      Comment?  @relation("CommentToComment", fields: [parentId], references: [id], onDelete: Cascade, onUpdate: NoAction)
    children    Comment[] @relation("CommentToComment")

    @@index([parentId], map: "idx_comments_parent")
    @@index([tableId, recordId], map: "idx_comments_table_record")
    @@map("__comments")
}

model AiConversation {
    id              String              @id @default(cuid())
    userId          String              @default("dev-user-001") @map("user_id")
    title           String              @default("New Chat")
    currentBaseId   String?             @map("current_base_id")
    currentTableId  String?             @map("current_table_id")
    currentViewId   String?             @map("current_view_id")
    createdAt       DateTime            @default(now()) @map("created_at") @db.Timestamp(6)
    updatedAt       DateTime            @default(now()) @map("updated_at") @db.Timestamp(6)
    approvedContexts AiApprovedContext[]
    messages        AiMessage[]

    @@index([userId], map: "idx_ai_conversations_user")
    @@map("ai_conversations")
}

model AiMessage {
    id              String          @id @default(cuid())
    conversationId  String          @map("conversation_id")
    role            String
    content         String
    actionType      String?         @map("action_type")
    actionPayload   Json?           @map("action_payload")
    createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamp(6)
    feedback        String?         @db.VarChar(10)
    conversation    AiConversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade, onUpdate: NoAction)

    @@index([conversationId], map: "idx_ai_messages_conversation")
    @@map("ai_messages")
}

model AiApprovedContext {
    id              String          @id @default(cuid())
    conversationId  String          @map("conversation_id")
    baseId          String          @map("base_id")
    tableId         String?         @map("table_id")
    approvedAt      DateTime        @default(now()) @map("approved_at") @db.Timestamp(6)
    conversation    AiConversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade, onUpdate: NoAction)

    @@unique([conversationId, baseId, tableId])
    @@index([conversationId], map: "idx_ai_approved_contexts_conversation")
    @@map("ai_approved_contexts")
}
