generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Ops {
  id          Int      @id @default(autoincrement())
  docId       String   @map("doc_id")
  docType     String   @map("doc_type")
  version     Int
  operation   String
  createdTime DateTime @default(now()) @map("created_time")
  createdBy   String   @map("created_by")

  @@map("ops")
}

model Space {
  id          String   @id @default(cuid()) @map("id")
  name        String?
  createdBy   String?
  status      String   @default("active")
  createdTime DateTime @default(now())

  bases Base[]

  @@index([status])
  @@map("space")
}

model Base {
  id          String   @id @default(cuid()) @map("id")
  spaceId     String
  name        String
  order       Int      @default(1)
  createdBy   String?
  source      String?
  status      String   @default("active")
  createdTime DateTime @default(now())

  space  Space       @relation(fields: [spaceId], references: [id])
  tables TableMeta[]

  @@index([status])
  @@index([spaceId])
  @@map("base")
}

model TableMeta {
  id               String       @id @default(cuid())
  name             String
  dbTableName      String?
  baseId           String
  order            Int          @default(1)
  status           String       @default("active")
  version          Int          @default(1)
  computedConfig   Json?
  createdTime      DateTime     @default(now())
  lastModifiedTime DateTime     @updatedAt
  createdBy        String?
  source_id        String?

  base       Base         @relation(fields: [baseId], references: [id])
  fields     field[]
  views      View[]
  dataStreams DataStream[]

  @@index([status])
  @@index([baseId])
  @@map("table_meta")
}

model field {
  id                Int      @id @default(autoincrement())
  name              String
  type              String
  dbFieldName       String
  dbFieldType       String
  cellValueType     String
  tableMetaId       String
  options           Json?    @map("options")
  lookupOptions     Json?
  format            Json?
  description       String?
  status            String   @default("active")
  order             Int      @default(0)
  isPrimary         Boolean  @default(false)
  isComputed        Boolean  @default(false)
  isRequired        Boolean  @default(false)
  isUnique          Boolean  @default(false)
  expression        String?
  computedFieldMeta Json?
  enrichment        Json?
  source_id         String?
  createdTime       DateTime @default(now())
  lastModifiedTime  DateTime @updatedAt
  nodeId            String?
  fieldFormat       Json?
  hasError          Boolean  @default(false)

  TableMeta TableMeta @relation(fields: [tableMetaId], references: [id])

  @@index([tableMetaId])
  @@index([status])
  @@map("field")
}

model View {
  id               String    @id @default(cuid())
  name             String
  type             String    @default("grid")
  tableId          String
  columnMeta       String?
  filter           Json?
  sort             Json?
  group            Json?
  options          Json?
  order            Float     @default(1)
  version          Int       @default(1)
  status           String    @default("active")
  isDefault        Boolean   @default(false)
  createdBy        String?
  source_id        String?
  shareId          String?
  enableShare      Boolean   @default(false)
  description      String?
  isLocked         Boolean   @default(false)
  orderColumn      String?
  deletedTime      DateTime?
  createdTime      DateTime  @default(now())
  lastModifiedTime DateTime  @updatedAt
  lastModifiedBy   String?
  shareMeta        Json?
  user_id          String?   @map("user_id")

  table TableMeta @relation(fields: [tableId], references: [id])

  @@index([status])
  @@index([tableId])
  @@map("view")
}

model DataStream {
  id                String             @id @default(cuid())
  tableId           String
  triggerType       String             @default("EVENT_BASED")
  isStreaming        Boolean            @default(false)
  status            String             @default("active")
  createdTime       DateTime           @default(now())
  eventType         String[]
  linkedAssetId     String?
  webhookUrl        String             @default("")

  table             TableMeta          @relation(fields: [tableId], references: [id])
  triggerSchedules  TriggerSchedule[]
  scheduledTriggers ScheduledTrigger[]

  @@unique([tableId, webhookUrl])
  @@index([status])
  @@index([tableId])
  @@map("data_stream")
}

model TriggerSchedule {
  id                String             @id @default(cuid())
  fieldId           Int
  type              String
  offsetMinutes     Int                @default(0)
  name              String?            @map("name")
  status            String             @default("active")
  createdTime       DateTime           @default(now())
  dataStreamId      String             @map("data_stream_id")
  deletedTime       DateTime?

  dataStream        DataStream         @relation(fields: [dataStreamId], references: [id], onDelete: Cascade)
  scheduledTriggers ScheduledTrigger[]

  @@index([dataStreamId])
  @@index([status])
  @@map("trigger_schedule")
}

model ScheduledTrigger {
  id                String          @id @default(cuid())
  dataStreamId      String          @map("data_stream_id")
  triggerScheduleId String          @map("trigger_schedule_id")
  recordId          Int             @map("record_id")
  trigger_time      DateTime
  tableId           String?
  originalFieldId   Int?
  originalTime      DateTime?       @db.Timestamptz(3)
  state             String          @default("PENDING")
  status            String          @default("active")
  nextRetryTime     DateTime?       @map("next_retry_time")
  scheduledTime     DateTime        @default(now()) @map("scheduled_time")
  createdTime       DateTime        @default(now()) @map("created_time")
  deletedTime       DateTime?       @map("deleted_time")
  lastError         String?         @map("last_error")
  lastModifiedTime  DateTime        @updatedAt @map("last_modified_time")
  maxRetries        Int             @default(3) @map("max_retries")
  retryCount        Int             @default(0) @map("retry_count")

  dataStream        DataStream      @relation(fields: [dataStreamId], references: [id], onDelete: Cascade)
  triggerSchedule   TriggerSchedule @relation(fields: [triggerScheduleId], references: [id], onDelete: Cascade)

  @@index([triggerScheduleId])
  @@index([dataStreamId])
  @@index([state])
  @@index([status])
  @@map("scheduled_trigger")
}

model Reference {
  id          Int      @id @default(autoincrement())
  fromFieldId Int
  toFieldId   Int
  createdTime DateTime @default(now())

  @@unique([fromFieldId, toFieldId])
  @@index([fromFieldId])
  @@index([toFieldId])
  @@map("reference")
}

model comments {
  id             Int        @id @default(dbgenerated("nextval('__comments_id_seq'::regclass)"))
  table_id       String
  record_id      String
  parent_id      Int?
  content        String
  user_id        String     @db.VarChar(255)
  user_name      String?    @db.VarChar(255)
  user_avatar    String?
  reactions      Json?      @default("{}")
  created_at     DateTime?  @default(now()) @db.Timestamptz(6)
  updated_at     DateTime?  @default(now()) @db.Timestamptz(6)
  deleted_at     DateTime?  @db.Timestamptz(6)
  comments       comments?  @relation("commentsTocomments", fields: [parent_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  other_comments comments[] @relation("commentsTocomments")

  @@index([parent_id], map: "idx_comments_parent")
  @@index([table_id, record_id], map: "idx_comments_table_record")
  @@map("__comments")
}

model ai_approved_contexts {
  id               Int              @id @default(autoincrement())
  conversation_id  Int
  base_id          String
  table_id         String?
  approved_at      DateTime         @default(now()) @db.Timestamp(6)
  ai_conversations ai_conversations @relation(fields: [conversation_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([conversation_id, base_id, table_id])
  @@index([conversation_id], map: "idx_ai_approved_contexts_conversation")
}

model ai_conversations {
  id                   Int                    @id @default(autoincrement())
  user_id              String                 @default("dev-user-001")
  title                String                 @default("New Chat")
  current_base_id      String?
  current_table_id     String?
  current_view_id      String?
  created_at           DateTime               @default(now()) @db.Timestamp(6)
  updated_at           DateTime               @default(now()) @db.Timestamp(6)
  ai_approved_contexts ai_approved_contexts[]
  ai_messages          ai_messages[]

  @@index([user_id], map: "idx_ai_conversations_user")
}

model ai_messages {
  id               Int              @id @default(autoincrement())
  conversation_id  Int
  role             String
  content          String
  action_type      String?
  action_payload   Json?
  created_at       DateTime         @default(now()) @db.Timestamp(6)
  feedback         String?          @db.VarChar(10)
  ai_conversations ai_conversations @relation(fields: [conversation_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([conversation_id], map: "idx_ai_messages_conversation")
}
