generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Ops {
  id          Int      @id @default(autoincrement())
  docId       String   @map("doc_id")
  docType     String   @map("doc_type")
  version     Int
  operation   String
  createdTime DateTime @default(now()) @map("created_time")
  createdBy   String   @map("created_by")

  @@map("ops")
}

model Space {
  id               String    @id @default(cuid()) @map("id")
  name             String
  credit           Int?
  deletedTime      DateTime? @map("deleted_time")
  createdTime      DateTime  @default(now()) @map("created_time")
  createdBy        String    @map("created_by")
  lastModifiedBy   String?   @map("last_modified_by")
  lastModifiedTime DateTime? @updatedAt @map("last_modified_time")
  status           String    @default("active")

  bases Base[]

  @@index([status])
  @@map("space")
}

model Base {
  id               String    @id @default(cuid()) @map("id")
  spaceId          String    @map("space_id")
  name             String
  order            Float
  icon             String?
  schemaPass       String?   @map("schema_pass")
  deletedTime      DateTime? @map("deleted_time")
  createdTime      DateTime  @default(now()) @map("created_time")
  createdBy        String    @map("created_by")
  lastModifiedBy   String?   @map("last_modified_by")
  lastModifiedTime DateTime? @updatedAt @map("last_modified_time")
  status           String    @default("active")
  source           String?   @default("")

  space  Space       @relation(fields: [spaceId], references: [id])
  tables TableMeta[]

  @@index([spaceId])
  @@index([order])
  @@index([status])
  @@map("base")
}

model TableMeta {
  id               String       @id @default(cuid())
  baseId           String       @map("base_id")
  name             String
  description      String?
  icon             String?
  dbTableName      String?      @map("db_table_name")
  version          Int          @default(1)
  order            Float
  createdTime      DateTime     @default(now()) @map("created_time")
  lastModifiedTime DateTime?    @updatedAt @map("last_modified_time")
  deletedTime      DateTime?    @map("deleted_time")
  createdBy        String       @map("created_by")
  lastModifiedBy   String?      @map("last_modified_by")
  status           String       @default("active")
  source_id        String?
  computedConfig   Json?        @default("{}") @map("computed_config")

  base        Base         @relation(fields: [baseId], references: [id])
  fields      field[]
  views       View[]
  dataStreams DataStream[]

  @@index([baseId])
  @@index([order])
  @@index([status])
  @@map("table_meta")
}

model field {
  id               Int       @id @default(autoincrement())
  name             String
  description      String?
  options          Json?     @map("options")
  type             String
  cellValueType    String    @map("cell_value_type")
  dbFieldType      String    @map("db_field_type")
  dbFieldName      String    @map("db_field_name")
  createdTime      DateTime  @default(now()) @map("created_time")
  lastModifiedTime DateTime? @updatedAt @map("last_modified_time")
  deletedTime      DateTime? @map("deleted_time")
  tableMetaId      String?
  nodeId           Json?     @map("node_id")
  status           String    @default("active")
  source_id        Int?
  computedFieldMeta Json?    @map("computed_field_meta")
  fieldFormat      Json?     @map("field_format")
  lookupOptions    Json?
  format           Json?
  order            Int       @default(0)
  isPrimary        Boolean   @default(false)
  isComputed       Boolean   @default(false)
  isRequired       Boolean   @default(false)
  isUnique         Boolean   @default(false)
  expression       String?
  hasError         Boolean   @default(false)
  enrichment       Json?

  TableMeta TableMeta? @relation(fields: [tableMetaId], references: [id])

  @@index([tableMetaId])
  @@index([status])
  @@map("field")
}

model View {
  id               String    @id @default(cuid())
  user_id          String?   @map("user_id")
  name             String
  description      String?
  tableId          String    @map("table_id")
  type             String    @default("grid")
  sort             Json?
  filter           Json?
  group            Json?
  options          Json?
  order            Float
  version          Int       @default(1)
  columnMeta       String    @map("column_meta")
  enableShare      Boolean?  @map("enable_share")
  shareId          String?   @map("share_id")
  shareMeta        String?   @map("share_meta")
  createdTime      DateTime  @default(now()) @map("created_time")
  lastModifiedTime DateTime? @updatedAt @map("last_modified_time")
  deletedTime      DateTime? @map("deleted_time")
  createdBy        String    @map("created_by")
  lastModifiedBy   String?   @map("last_modified_by")
  source_id        String?
  status           String    @default("active")
  isDefault        Boolean   @default(false)
  isLocked         Boolean   @default(false)
  orderColumn      String?

  table TableMeta @relation(fields: [tableId], references: [id])

  @@index([tableId])
  @@index([order])
  @@index([status])
  @@map("view")
}

model DataStream {
  id                String             @id @default(cuid())
  tableId           String             @map("table_id")
  webhookUrl        String             @map("webhook_url")
  isStreaming        Boolean            @default(false) @map("is_streaming")
  createdTime       DateTime           @default(now()) @map("created_time")
  lastModifiedTime  DateTime?          @updatedAt @map("last_modified_time")
  eventType         Json?              @map("event_type")
  linkedAssetId     String?            @map("linked_asset_id")
  triggerType       String?            @map("trigger_type")
  status            String             @default("active")

  table             TableMeta          @relation(fields: [tableId], references: [id])
  triggerSchedules  TriggerSchedule[]
  scheduledTriggers ScheduledTrigger[]

  @@unique([tableId, webhookUrl])
  @@index([tableId])
  @@index([status])
  @@map("data_stream")
}

model TriggerSchedule {
  id                String             @id @default(cuid())
  dataStreamId      String             @map("data_stream_id")
  fieldId           Int                @map("field_id")
  type              String
  offsetMinutes     Int                @map("offset_minutes")
  name              String             @map("name")
  status            String             @default("active")
  createdTime       DateTime           @default(now()) @map("created_time")
  lastModifiedTime  DateTime?          @updatedAt @map("last_modified_time")
  deletedTime       DateTime?          @map("deleted_time")

  dataStream        DataStream         @relation(fields: [dataStreamId], references: [id], onDelete: Cascade)
  scheduledTriggers ScheduledTrigger[]

  @@index([dataStreamId])
  @@index([status])
  @@map("trigger_schedule")
}

model ScheduledTrigger {
  id                String          @id @default(cuid())
  dataStreamId      String          @map("data_stream_id")
  triggerScheduleId String          @map("trigger_schedule_id")
  recordId          Int             @map("record_id")
  tableId           String          @map("table_id")
  originalFieldId   Int             @map("original_field_id")
  scheduledTime     DateTime        @map("scheduled_time") @db.Timestamptz(3)
  originalTime      DateTime        @map("original_time") @db.Timestamptz(3)
  state             String          @default("PENDING")
  status            String          @default("active")
  retryCount        Int             @default(0) @map("retry_count")
  maxRetries        Int             @default(3) @map("max_retries")
  nextRetryTime     DateTime?       @map("next_retry_time") @db.Timestamptz(3)
  lastError         String?         @map("last_error")
  createdTime       DateTime        @default(now()) @map("created_time")
  lastModifiedTime  DateTime?       @updatedAt @map("last_modified_time")
  deletedTime       DateTime?       @map("deleted_time")

  dataStream        DataStream      @relation(fields: [dataStreamId], references: [id], onDelete: Cascade)
  triggerSchedule   TriggerSchedule @relation(fields: [triggerScheduleId], references: [id], onDelete: Cascade)

  @@index([status, state, scheduledTime])
  @@index([status, state, nextRetryTime])
  @@index([triggerScheduleId])
  @@map("scheduled_trigger")
}

model Reference {
  id            Int      @id @default(autoincrement())
  fromFieldId   Int
  toFieldId     Int
  createdTime   DateTime @default(now())

  @@unique([fromFieldId, toFieldId])
  @@index([fromFieldId])
  @@index([toFieldId])
  @@map("reference")
}
